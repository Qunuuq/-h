<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุญุฏูุซ ุงูููู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ุงุณุชุฎุฏุงู ุฎุท Inter ูุชุญุณูู ุฌูุงููุฉ ุงููุต ููุงุจููุชู ูููุฑุงุกุฉ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* ููู ุฎูููุฉ ูุงุชุญ ูููุฏุฆ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* ูุถูู ุฃู ุงูุตูุญุฉ ุชุฃุฎุฐ ูุงูู ุงุฑุชูุงุน ุงูุดุงุดุฉ */
            margin: 0;
            padding: 20px; /* ูุณุงูุฉ ุฏุงุฎููุฉ ุญูู ุงููุญุชูู ุงูุฑุฆูุณู */
            box-sizing: border-box; /* ูุถูู ุฃู ุงูุญุดูุฉ ูุง ุชุฒูุฏ ูู ุญุฌู ุงูุนูุตุฑ */
        }
        /* ุชุญุฏูุฏ ุงุชุฌุงู ุงููุต ูููููู ููุญุงุฐุงุฉ ุงููุต ูููููู ููุนูุงุตุฑ ุงูุชู ุชุญุชุงุฌ ุฐูู ุจุดูู ุฎุงุต */
        .text-arabic {
            direction: rtl;
            text-align: right;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full text-center border border-gray-200">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">ุญุฏูุซ ุงูููู</h1>

        <div class="mb-6">
            <button id="fetchNewHadithBtn"
                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg
                           transition duration-300 ease-in-out transform hover:scale-105
                           focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                ุญุฏูุซ ุฌุฏูุฏ
            </button>
        </div>

        <div id="hadithDisplay" class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200 text-arabic">
            <p class="text-gray-700 text-lg leading-relaxed mb-4" id="hadithText">
                ุงุถุบุท ุนูู ุงูุฒุฑ ุฃุนูุงู ูุฌูุจ ุญุฏูุซ ุดุฑูู ุฌุฏูุฏ.
            </p>
            <p class="text-gray-500 text-sm font-medium" id="hadithSource">
                ุงููุตุฏุฑ: -
            </p>
            <button id="copyHadithBtn"
                    class="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg
                           transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 text-sm">
                ูุณุฎ ุงูุญุฏูุซ
            </button>
            <span id="hadithCopyStatus" class="text-sm text-green-600 ml-2 hidden">ุชู ุงููุณุฎ!</span>
        </div>

        <div class="mt-4 flex flex-wrap justify-center gap-4">
            <button id="explainHadithBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg
                           transition duration-300 ease-in-out transform hover:scale-105
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                โจ ุงุดุฑุญ ุงูุญุฏูุซ
            </button>
            <button id="extractLessonsBtn"
                    class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg
                           transition duration-300 ease-in-out transform hover:scale-105
                           focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-50">
                โจ ุงุณุชุฎูุต ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ
            </button>
            <button id="practicalApplicationsBtn"
                    class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-6 rounded-lg
                           transition duration-300 ease-in-out transform hover:scale-105
                           focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">
                โจ ุชุทุจููุงุช ุนูููุฉ
            </button>
        </div>

        <div class="mb-6 mt-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">ุงุณุฃู ุงูุฐูุงุก ุงูุงุตุทูุงุนู</h2>
            <div class="mb-4 flex items-center justify-center gap-2">
                <label for="searchInput" class="sr-only">ุงุทุฑุญ ุณุคุงูู ููุง:</label>
                <input type="text" id="searchInput" placeholder="ุงุทุฑุญ ุณุคุงูู ููุง"
                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <button id="askAIBtn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg
                           transition duration-300 ease-in-out transform hover:scale-105
                           focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                ๐ก ุงุณุฃู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
            </button>
        </div>

        <div id="explanationDisplay" class="hidden mt-8 p-6 bg-blue-50 rounded-lg border border-blue-200 text-arabic">
            <h3 class="text-xl font-semibold text-blue-800 mb-2">ุดุฑุญ ุงูุญุฏูุซ:</h3>
            <p class="text-blue-800 text-lg leading-relaxed" id="explanationText">
                ุงูุดุฑุญ ุณูุธูุฑ ููุง...
            </p>
            <button id="copyExplanationBtn"
                    class="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg
                           transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 text-sm">
                ูุณุฎ ุงูุดุฑุญ
            </button>
            <span id="explanationCopyStatus" class="text-sm text-green-600 ml-2 hidden">ุชู ุงููุณุฎ!</span>
        </div>

        <div id="lessonsDisplay" class="hidden mt-8 p-6 bg-orange-50 rounded-lg border border-orange-200 text-arabic">
            <h3 class="text-xl font-semibold text-orange-800 mb-2">ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ:</h3>
            <p class="text-orange-800 text-lg leading-relaxed" id="lessonsText">
                ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ ุณุชุธูุฑ ููุง...
            </p>
            <button id="copyLessonsBtn"
                    class="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg
                           transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 text-sm">
                ูุณุฎ ุงูุฏุฑูุณ
            </button>
            <span id="lessonsCopyStatus" class="text-sm text-green-600 ml-2 hidden">ุชู ุงููุณุฎ!</span>
        </div>

        <div id="practicalApplicationsDisplay" class="hidden mt-8 p-6 bg-teal-50 rounded-lg border border-teal-200 text-arabic">
            <h3 class="text-xl font-semibold text-teal-800 mb-2">ุชุทุจููุงุช ุนูููุฉ:</h3>
            <p class="text-teal-800 text-lg leading-relaxed" id="practicalApplicationsText">
                ุงูุชุทุจููุงุช ุงูุนูููุฉ ุณุชุธูุฑ ููุง...
            </p>
            <button id="copyPracticalApplicationsBtn"
                    class="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg
                           transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 text-sm">
                ูุณุฎ ุงูุชุทุจููุงุช
            </button>
            <span id="practicalApplicationsCopyStatus" class="text-sm text-green-600 ml-2 hidden">ุชู ุงููุณุฎ!</span>
        </div>

        <div id="aiAnswerDisplay" class="hidden mt-8 p-6 bg-indigo-50 rounded-lg border border-indigo-200 text-arabic">
            <h3 class="text-xl font-semibold text-indigo-800 mb-2">ุฅุฌุงุจุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู:</h3>
            <p class="text-indigo-800 text-lg leading-relaxed" id="aiAnswerText">
                ุงูุฅุฌุงุจุฉ ุณุชุธูุฑ ููุง...
            </p>
            <button id="copyAIAnswerBtn"
                    class="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg
                           transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 text-sm">
                ูุณุฎ ุงูุฅุฌุงุจุฉ
            </button>
            <span id="aiAnswerCopyStatus" class="text-sm text-green-600 ml-2 hidden">ุชู ุงููุณุฎ!</span>
        </div>

        <div id="loadingIndicator" class="hidden mt-4 text-gray-600 font-medium">
            ุฌุงุฑู ุงูุชุญููู...
        </div>

        <div id="explanationLoadingIndicator" class="hidden mt-4 text-gray-600 font-medium">
            ุฌุงุฑู ุดุฑุญ ุงูุญุฏูุซ...
        </div>

        <div id="lessonsLoadingIndicator" class="hidden mt-4 text-gray-600 font-medium">
            ุฌุงุฑู ุงุณุชุฎูุงุต ุงูุฏุฑูุณ...
        </div>

        <div id="practicalApplicationsLoadingIndicator" class="hidden mt-4 text-gray-600 font-medium">
            ุฌุงุฑู ุงูุชุฑุงุญ ุชุทุจููุงุช ุนูููุฉ...
        </div>

        <div id="aiAnswerLoadingIndicator" class="hidden mt-4 text-gray-600 font-medium">
            ุฌุงุฑู ุงูุฅุฌุงุจุฉ...
        </div>

        <div id="errorDisplay" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-200">
            ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฌูุจ ุงูุญุฏูุซ. ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.
        </div>

        <div id="explanationErrorDisplay" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-200">
            ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุดุฑุญ ุงูุญุฏูุซ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.
        </div>

        <div id="lessonsErrorDisplay" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-200">
            ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุฎูุงุต ุงูุฏุฑูุณ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.
        </div>

        <div id="practicalApplicationsErrorDisplay" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-200">
            ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุฑุงุญ ุชุทุจููุงุช ุนูููุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.
        </div>

        <div id="aiAnswerErrorDisplay" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-200">
            ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุณุคุงูู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.
        </div>
    </div>

    <script>
        // Getting references to DOM elements by their IDs
        const fetchNewHadithBtn = document.getElementById('fetchNewHadithBtn');
        const explainHadithBtn = document.getElementById('explainHadithBtn');
        const extractLessonsBtn = document.getElementById('extractLessonsBtn');
        const practicalApplicationsBtn = document.getElementById('practicalApplicationsBtn');
        const searchInput = document.getElementById('searchInput');
        const askAIBtn = document.getElementById('askAIBtn');

        const hadithText = document.getElementById('hadithText');
        const hadithSource = document.getElementById('hadithSource');
        const copyHadithBtn = document.getElementById('copyHadithBtn');
        const hadithCopyStatus = document.getElementById('hadithCopyStatus');

        const explanationDisplay = document.getElementById('explanationDisplay');
        const explanationText = document.getElementById('explanationText');
        const copyExplanationBtn = document.getElementById('copyExplanationBtn');
        const explanationCopyStatus = document.getElementById('explanationCopyStatus');

        const lessonsDisplay = document.getElementById('lessonsDisplay');
        const lessonsText = document.getElementById('lessonsText');
        const copyLessonsBtn = document.getElementById('copyLessonsBtn');
        const lessonsCopyStatus = document.getElementById('lessonsCopyStatus');

        const practicalApplicationsDisplay = document.getElementById('practicalApplicationsDisplay');
        const practicalApplicationsText = document.getElementById('practicalApplicationsText');
        const copyPracticalApplicationsBtn = document.getElementById('copyPracticalApplicationsBtn');
        const practicalApplicationsCopyStatus = document.getElementById('practicalApplicationsCopyStatus');

        const aiAnswerDisplay = document.getElementById('aiAnswerDisplay');
        const aiAnswerText = document.getElementById('aiAnswerText');
        const copyAIAnswerBtn = document.getElementById('copyAIAnswerBtn');
        const aiAnswerCopyStatus = document.getElementById('aiAnswerCopyStatus');

        const loadingIndicator = document.getElementById('loadingIndicator');
        const explanationLoadingIndicator = document.getElementById('explanationLoadingIndicator');
        const lessonsLoadingIndicator = document.getElementById('lessonsLoadingIndicator');
        const practicalApplicationsLoadingIndicator = document.getElementById('practicalApplicationsLoadingIndicator');
        const aiAnswerLoadingIndicator = document.getElementById('aiAnswerLoadingIndicator');
        const errorDisplay = document.getElementById('errorDisplay');
        const explanationErrorDisplay = document.getElementById('explanationErrorDisplay');
        const lessonsErrorDisplay = document.getElementById('lessonsErrorDisplay');
        const practicalApplicationsErrorDisplay = document.getElementById('practicalApplicationsErrorDisplay');
        const aiAnswerErrorDisplay = document.getElementById('aiAnswerErrorDisplay');

        // List of available Hadith books and their available count
        const hadithBooksData = [
            { name: "HR. Abu Daud", id: "abu-daud", available: 4419 },
            { name: "HR. Ahmad", id: "ahmad", available: 4305 },
            { name: "HR. Bukhari", id: "bukhari", available: 6638 },
            { name: "HR. Darimi", id: "darimi", available: 2949 },
            { name: "HR. Ibnu Majah", id: "ibnu-majah", available: 4285 },
            { name: "HR. Malik", id: "malik", available: 1587 },
            { name: "HR. Muslim", id: "muslim", available: 4930 },
            { name: "HR. Nasai", id: "nasai", available: 5364 },
            { name: "HR. Tirmidzi", id: "tirmidzi", available: 3625 }
        ];

        // Speech Synthesis variables (kept for reading out AI answers)
        let synth;
        let arabicVoice;

        // Initialize SpeechSynthesis
        if ('speechSynthesis' in window) {
            synth = window.speechSynthesis;
            synth.onvoiceschanged = () => {
                const voices = synth.getVoices();
                arabicVoice = voices.find(voice => voice.lang.startsWith('ar')) || voices.find(voice => voice.lang.includes('ar'));
                if (!arabicVoice) {
                    console.warn('No Arabic voice found. Default voice will be used.');
                }
            };
        } else {
            console.warn('Your browser does not support speech output.');
        }

        /**
         * Helper function to disable or enable all buttons.
         * @param {boolean} disable - true to disable buttons, false to enable them.
         */
        function disableAllButtons(disable) {
            fetchNewHadithBtn.disabled = disable;
            explainHadithBtn.disabled = disable;
            extractLessonsBtn.disabled = disable;
            practicalApplicationsBtn.disabled = disable;
            askAIBtn.disabled = disable;
            copyHadithBtn.disabled = disable;
            copyExplanationBtn.disabled = disable;
            copyLessonsBtn.disabled = disable;
            copyPracticalApplicationsBtn.disabled = disable;
            copyAIAnswerBtn.disabled = disable;
        }

        // Helper function to hide all status messages, extra display areas, and copy statuses
        function hideAllStatusMessages() {
            loadingIndicator.classList.add('hidden');
            explanationLoadingIndicator.classList.add('hidden');
            lessonsLoadingIndicator.classList.add('hidden');
            practicalApplicationsLoadingIndicator.classList.add('hidden');
            aiAnswerLoadingIndicator.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            explanationErrorDisplay.classList.add('hidden');
            lessonsErrorDisplay.classList.add('hidden');
            practicalApplicationsErrorDisplay.classList.add('hidden');
            aiAnswerErrorDisplay.classList.add('hidden');
            explanationDisplay.classList.add('hidden');
            lessonsDisplay.classList.add('hidden');
            practicalApplicationsDisplay.classList.add('hidden');
            aiAnswerDisplay.classList.add('hidden');

            // Hide copy status messages
            hadithCopyStatus.classList.add('hidden');
            explanationCopyStatus.classList.add('hidden');
            lessonsCopyStatus.classList.add('hidden');
            practicalApplicationsCopyStatus.classList.add('hidden');
            aiAnswerCopyStatus.classList.add('hidden');
        }

        /**
         * Helper function to copy text to clipboard.
         * Uses document.execCommand('copy') as navigator.clipboard.writeText() might not work in iframe environments.
         * @param {string} textToCopy - The text to be copied.
         * @param {HTMLElement} statusElement - The element that will display the status message (e.g., "Copied!").
         */
        function copyTextToClipboard(textToCopy, statusElement) {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                if (statusElement) {
                    statusElement.classList.remove('hidden');
                    setTimeout(() => {
                        statusElement.classList.add('hidden');
                    }, 2000); // Hide message after 2 seconds
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
                // Optionally, add a visible error message to the user here
            } finally {
                document.body.removeChild(tempTextArea);
            }
        }

        /**
         * Asynchronous function to fetch a random hadith from a selected book.
         * A random number is chosen within the available range of hadiths for the book.
         */
        async function fetchHadithOfTheDay() {
            hideAllStatusMessages(); // Hide all messages before starting
            loadingIndicator.classList.remove('hidden');
            disableAllButtons(true); // Disable all buttons

            try {
                // Choose a random book from the list of available books
                const randomBookData = hadithBooksData[Math.floor(Math.random() * hadithBooksData.length)];
                const randomBookId = randomBookData.id;
                const maxHadithNumber = randomBookData.available;

                // Choose a random hadith number within the available range for this book
                const randomHadithNumber = Math.floor(Math.random() * maxHadithNumber) + 1;

                const apiUrl = `https://api.hadith.gading.dev/books/${randomBookId}/${randomHadithNumber}`;
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data && data.data && data.data.contents && data.data.contents.arab) {
                    hadithText.textContent = data.data.contents.arab;
                    hadithSource.textContent = `ุงููุตุฏุฑ: ${data.data.name} - ุญุฏูุซ ุฑูู ${data.data.contents.number}`;
                } else {
                    console.warn(`Hadith not found for ${randomBookId} at number ${randomHadithNumber}. Trying again.`);
                    await fetchHadithOfTheDay(); // Try fetching another hadith
                    return; // End current execution to avoid updating the UI twice
                }

            } catch (error) {
                console.error('Error fetching hadith:', error);
                errorDisplay.classList.remove('hidden');
                hadithText.textContent = 'ุชุนุฐุฑ ุฌูุจ ุงูุญุฏูุซ. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.';
                hadithSource.textContent = 'ุงููุตุฏุฑ: -';
            } finally {
                loadingIndicator.classList.add('hidden');
                disableAllButtons(false); // Re-enable all buttons
            }
        }

        /**
         * Asynchronous function to explain the hadith using Gemini API.
         */
        async function explainHadith() {
            const currentHadith = hadithText.textContent;

            if (!currentHadith || currentHadith.includes('ุงุถุบุท ุนูู ุงูุฒุฑ') || currentHadith.includes('ุชุนุฐุฑ ุฌูุจ ุงูุญุฏูุซ') || currentHadith.includes('ูู ูุชู ุงูุนุซูุฑ ุนูู ุญุฏูุซ')) {
                explanationText.textContent = 'ูุฑุฌู ุฌูุจ ุญุฏูุซ ุฃููุงู ูุจู ุทูุจ ุงูุดุฑุญ.';
                explanationDisplay.classList.remove('hidden');
                return;
            }

            hideAllStatusMessages(); // Hide all other messages and areas
            explanationLoadingIndicator.classList.remove('hidden');
            disableAllButtons(true); // Disable all buttons

            try {
                const prompt = `ุงุดุฑุญ ุงูุญุฏูุซ ุงูุชุงูู ุจุฃุณููุจ ูุจุณุท ููุฎุชุตุฑุ ูุน ุงูุชุฑููุฒ ุนูู ุงููุนูู ุงูุนุงู ูุงููุงุฆุฏุฉ ุงููุณุชูุงุฏุฉ ูููุ ูุจูุง ูุง ูุชุฌุงูุฒ 150 ูููุฉุ ูุน ุฐูุฑ ุงููุตุฏุฑ ุฅู ุฃููู: "${currentHadith}"`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // IMPORTANT: When deploying this application outside of the Google Canvas environment,
                // you need to provide your own Gemini API Key.
                // You can get one from Google AI Studio: https://aistudio.google.com/app/apikey
                //
                // WARNING: Directly embedding API keys in client-side code is NOT secure for production applications.
                // For production, it is highly recommended to use a backend proxy server to keep your API key secure.
                const apiKey = "AIzaSyDbeleLFWRXBWVMS7eyzRvoR6Sj-wsIjwY"; // <-- ููุชุงุญ ุงูู API ุงูุฎุงุต ุจู ููุง
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const explanation = result.candidates[0].content.parts[0].text;
                    explanationText.textContent = explanation;
                    explanationDisplay.classList.remove('hidden');
                } else {
                    throw new Error('ููุงู ุฎุทุง ุจุณุจุจ ุงูุดุฑุญ ุจูุงุณุทู ุงูุฐูุงุก ุงูุงุตุทูุงุนู');
                }

            } catch (error) {
                console.error('Error explaining hadith:', error);
                explanationErrorDisplay.classList.remove('hidden');
                explanationText.textContent = 'ุชุนุฐุฑ ุดุฑุญ ุงูุญุฏูุซ. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.';
                explanationDisplay.classList.remove('hidden');
            } finally {
                explanationLoadingIndicator.classList.add('hidden');
                disableAllButtons(false); // Re-enable all buttons
            }
        }

        /**
         * Asynchronous function to extract lessons learned from the hadith using Gemini API.
         */
        async function extractLessons() {
            const currentHadith = hadithText.textContent;

            if (!currentHadith || currentHadith.includes('ุงุถุบุท ุนูู ุงูุฒุฑ') || currentHadith.includes('ุชุนุฐุฑ ุฌูุจ ุงูุญุฏูุซ') || currentHadith.includes('ูู ูุชู ุงูุนุซูุฑ ุนูู ุญุฏูุซ')) {
                lessonsText.textContent = 'ูุฑุฌู ุฌูุจ ุญุฏูุซ ุฃููุงู ูุจู ุทูุจ ุงุณุชุฎูุงุต ุงูุฏุฑูุณ.';
                lessonsDisplay.classList.remove('hidden');
                return;
            }

            hideAllStatusMessages(); // Hide all other messages and areas
            lessonsLoadingIndicator.classList.remove('hidden');
            disableAllButtons(true); // Disable all buttons

            try {
                const prompt = `ุงุณุชุฎูุต ุฃูู 3-5 ุฏุฑูุณ ุฃู ููุงุฆุฏ ูุณุชูุงุฏุฉ ูู ุงูุญุฏูุซ ุงูุชุงูู ุจุฃุณููุจ ููุทู ููุฎุชุตุฑ: "${currentHadith}"`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // IMPORTANT: When deploying this application outside of the Google Canvas environment,
                // you need to provide your own Gemini API Key.
                // You can get one from Google AI Studio: https://aistudio.google.com/app/apikey
                //
                // WARNING: Directly embedding API keys in client-side code is NOT secure for production applications.
                // For production, it is highly recommended to use a backend proxy server to keep your API key secure.
                const apiKey = "AIzaSyDbeleLFWRXBWVMS7eyzRvoR6Sj-wsIjwY"; // <-- ููุชุงุญ ุงูู API ุงูุฎุงุต ุจู ููุง
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const lessons = result.candidates[0].content.parts[0].text;
                    lessonsText.textContent = lessons;
                    lessonsDisplay.classList.remove('hidden');
                } else {
                    throw new Error('ูู ูุชู ุงูุญุตูู ุนูู ุฏุฑูุณ ูู Gemini API.');
                }

            } catch (error) {
                console.error('Error extracting lessons:', error);
                lessonsErrorDisplay.classList.remove('hidden');
                lessonsText.textContent = 'ุชุนุฐุฑ ุงุณุชุฎูุงุต ุงูุฏุฑูุณ. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.';
                lessonsDisplay.classList.remove('hidden');
            } finally {
                lessonsLoadingIndicator.classList.add('hidden');
                disableAllButtons(false); // Re-enable all buttons
            }
        }

        /**
         * Asynchronous function to generate practical applications for the hadith using Gemini API.
         */
        async function generatePracticalApplications() {
            const currentHadith = hadithText.textContent;

            if (!currentHadith || currentHadith.includes('ุงุถุบุท ุนูู ุงูุฒุฑ') || currentHadith.includes('ุชุนุฐุฑ ุฌูุจ ุงูุญุฏูุซ') || currentHadith.includes('ูู ูุชู ุงูุนุซูุฑ ุนูู ุญุฏูุซ')) {
                practicalApplicationsText.textContent = 'ูุฑุฌู ุฌูุจ ุญุฏูุซ ุฃููุงู ูุจู ุทูุจ ุชุทุจููุงุช ุนูููุฉ.';
                practicalApplicationsDisplay.classList.remove('hidden');
                return;
            }

            hideAllStatusMessages(); // Hide all other messages and areas
            practicalApplicationsLoadingIndicator.classList.remove('hidden');
            disableAllButtons(true); // Disable all buttons

            try {
                const prompt = `ุจูุงุกู ุนูู ุงูุญุฏูุซ ุงูุชุงููุ ุงูุชุฑุญ 3-5 ุชุทุจููุงุช ุนูููุฉ ุฃู ุฎุทูุงุช ูููู ูููุณูู ุงุชุฎุงุฐูุง ูู ุญูุงุชู ุงูููููุฉ ูุชุทุจูู ูุฐุง ุงูุญุฏูุซุ ุจุฃุณููุจ ููุทู ููุฎุชุตุฑ: "${currentHadith}"`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // IMPORTANT: When deploying this application outside of the Google Canvas environment,
                // you need to provide your own Gemini API Key.
                // You can get one from Google AI Studio: https://aistudio.google.com/app/apikey
                //
                // WARNING: Directly embedding API keys in client-side code is NOT secure for production applications.
                // For production, it is highly recommended to use a backend proxy server to keep your API key secure.
                const apiKey = "AIzaSyDbeleLFWRXBWVMS7eyzRvoR6Sj-wsIjwY"; // <-- ููุชุงุญ ุงูู API ุงูุฎุงุต ุจู ููุง
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const applications = result.candidates[0].content.parts[0].text;
                    practicalApplicationsText.textContent = applications;
                    practicalApplicationsDisplay.classList.remove('hidden');
                } else {
                    throw new Error('ูู ูุชู ุงูุญุตูู ุนูู ุชุทุจููุงุช ุนูููุฉ ูู Gemini API.');
                }

            } catch (error) {
                console.error('Error generating practical applications:', error);
                practicalApplicationsErrorDisplay.classList.remove('hidden');
                practicalApplicationsText.textContent = 'ุชุนุฐุฑ ุงูุชุฑุงุญ ุชุทุจููุงุช ุนูููุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.';
                practicalApplicationsDisplay.classList.remove('hidden');
            } finally {
                practicalApplicationsLoadingIndicator.classList.add('hidden');
                disableAllButtons(false); // Re-enable all buttons
            }
        }

        /**
         * Asynchronous function to answer user questions using Gemini API.
         */
        async function askAI() {
            const query = searchInput.value.trim();

            if (!query) {
                aiAnswerText.textContent = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุณุคุงูู.';
                aiAnswerDisplay.classList.remove('hidden');
                return;
            }

            hideAllStatusMessages(); // Hide all other messages and areas
            aiAnswerLoadingIndicator.classList.remove('hidden');
            disableAllButtons(true); // Disable all buttons

            try {
                const prompt = `ุฃุฌุจ ุนูู ุงูุณุคุงู ุงูุชุงูู ุจูุงุกู ุนูู ูุนุฑูุชู ุจุงูุฃุญุงุฏูุซ ูุงูููุงููู ุงูุฅุณูุงููุฉ: "${query}". ูุฏู ุฅุฌุงุจุฉ ุดุงููุฉ ููุฎุชุตุฑุฉ.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // IMPORTANT: When deploying this application outside of the Google Canvas environment,
                // you need to provide your own Gemini API Key.
                // You can get one from Google AI Studio: https://aistudio.google.com/app/apikey
                //
                // WARNING: Directly embedding API keys in client-side code is NOT secure for production applications.
                // For production, it is highly recommended to use a backend proxy server to keep your API key secure.
                const apiKey = "AIzaSyDbeleLFWRXBWVMS7eyzRvoR6Sj-wsIjwY"; // <-- ููุชุงุญ ุงูู API ุงูุฎุงุต ุจู ููุง
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const answer = result.candidates[0].content.parts[0].text;
                    aiAnswerText.textContent = answer;
                    aiAnswerDisplay.classList.remove('hidden');

                    // Read the answer aloud
                    if (synth && arabicVoice) {
                        const utterance = new SpeechSynthesisUtterance(answer);
                        utterance.voice = arabicVoice;
                        utterance.lang = 'ar-SA';
                        synth.speak(utterance);
                    } else if (synth) {
                        const utterance = new SpeechSynthesisUtterance(answer);
                        synth.speak(utterance);
                    }

                } else {
                    throw new Error('ูู ูุชู ุงูุญุตูู ุนูู ุฅุฌุงุจุฉ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู.');
                }

            } catch (error) {
                console.error('Error answering question:', error);
                aiAnswerErrorDisplay.classList.remove('hidden');
                aiAnswerText.textContent = 'ุชุนุฐุฑ ุงูุฅุฌุงุจุฉ ุนูู ุณุคุงูู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.';
                aiAnswerDisplay.classList.remove('hidden');
            } finally {
                aiAnswerLoadingIndicator.classList.add('hidden');
                disableAllButtons(false); // Re-enable all buttons
            }
        }

        // Add click listener for "Fetch New Hadith" button
        fetchNewHadithBtn.addEventListener('click', fetchHadithOfTheDay);

        // Add click listener for "Explain Hadith" button
        explainHadithBtn.addEventListener('click', explainHadith);

        // Add click listener for "Extract Lessons" button
        extractLessonsBtn.addEventListener('click', extractLessons);

        // Add click listener for "Practical Applications" button
        practicalApplicationsBtn.addEventListener('click', generatePracticalApplications);

        // Add click listener for "Ask AI" button
        askAIBtn.addEventListener('click', askAI);

        // Add click listeners for copy buttons
        copyHadithBtn.addEventListener('click', () => copyTextToClipboard(hadithText.textContent, hadithCopyStatus));
        copyExplanationBtn.addEventListener('click', () => copyTextToClipboard(explanationText.textContent, explanationCopyStatus));
        copyLessonsBtn.addEventListener('click', () => copyTextToClipboard(lessonsText.textContent, lessonsCopyStatus));
        copyPracticalApplicationsBtn.addEventListener('click', () => copyTextToClipboard(practicalApplicationsText.textContent, practicalApplicationsCopyStatus));
        copyAIAnswerBtn.addEventListener('click', () => copyTextToClipboard(aiAnswerText.textContent, aiAnswerCopyStatus));


        // Fetch a hadith automatically on page load
        document.addEventListener('DOMContentLoaded', fetchHadithOfTheDay);
    </script>
</body>
</html>
