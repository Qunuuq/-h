<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حديث اليوم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* استخدام خط Amiri لتحسين جمالية النص وقابليته للقراءة */
        body {
            font-family: 'Amiri', serif; /* تطبيق خط Amiri */
            background: linear-gradient(135deg, #e0f2f7, #c1e8f0); /* تدرج لوني أزرق-أخضر هادئ */
            background-size: 400% 400%;
            animation: gradientAnimation 20s ease infinite; /* رسومات متحركة للخلفية بشكل أبطأ وأكثر سلاسة */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* رسومات متحركة للخلفية */
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* تحديد اتجاه النص لليمين ومحاذاة النص لليمين للعناصر التي تحتاج ذلك بشكل خاص */
        .text-arabic {
            direction: rtl;
            text-align: right;
            line-height: 1.8; /* لتحسين قابلية القراءة للنصوص الطويلة */
        }

        /* تحسينات عامة للعناصر الرئيسية */
        .card-container {
            background-color: #ffffff;
            border-radius: 2rem; /* زوايا مستديرة أكثر وضوحاً */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.18); /* ظل أعمق وأكثر انتشاراً */
            padding: 3rem; /* حشوة أكبر للمساحة والراحة */
            max-width: 52rem; /* عرض أقصى أوسع */
            width: 100%;
            border: 1px solid #e2e8f0;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* انتقال للتحويم */
        }
        .card-container:hover {
            transform: translateY(-8px); /* تأثير رفع خفيف عند التحويم */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25); /* ظل أكبر عند التحويم */
        }

        .content-display {
            background-color: #f8fafc; /* لون خلفية فاتح للمحتوى */
            border-radius: 1.25rem; /* زوايا مستديرة للمحتوى */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08); /* ظل خفيف للمحتوى */
            padding: 2rem;
            margin-top: 2.5rem;
            border: 1px solid #edf2f7;
            opacity: 0; /* للرسومات المتحركة عند التحميل */
            transform: translateY(30px); /* للرسومات المتحركة عند التحميل */
            animation: fadeInSlideUp 0.6s ease-out forwards; /* رسومات متحركة أبطأ قليلاً */
        }

        /* رسومات متحركة لظهور المحتوى */
        @keyframes fadeInSlideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* تحسين أزرار النسخ */
        .copy-button {
            background-color: #e2e8f0; /* لون رمادي فاتح جديد */
            color: #4a5568; /* نص رمادي داكن */
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            border-radius: 0.8rem; /* زوايا مستديرة أكثر */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .copy-button:hover {
            background-color: #cbd5e1; /* رمادي أغمق عند التحويم */
            transform: translateY(-2px); /* تأثير رفع خفيف */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .copy-status {
            font-size: 0.9rem; /* حجم خط صغير */
            color: #10b981; /* أخضر جميل */
            margin-right: 0.6rem;
            font-weight: bold;
        }

        /* تحسينات لأزرار الإجراءات الرئيسية */
        .action-button {
            font-weight: bold;
            padding: 0.9rem 1.8rem;
            border-radius: 1rem; /* زوايا مستديرة أكبر */
            transition: all 0.3s ease-in-out transform hover:scale-105 hover:shadow-xl; /* ظل أكبر عند التحويم */
            focus:outline-none focus:ring-4;
        }

        /* تخصيص ألوان أزرار الإجراءات */
        #fetchNewHadithBtn {
            background-color: #22c55e; /* أخضر */
            color: white;
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3);
        }
        #fetchNewHadithBtn:hover {
            background-color: #16a34a;
        }

        #explainHadithBtn {
            background-color: #3b82f6; /* أزرق */
            color: white;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }
        #explainHadithBtn:hover {
            background-color: #2563eb;
        }

        #extractLessonsBtn {
            background-color: #f97316; /* برتقالي */
            color: white;
            box-shadow: 0 5px 15px rgba(249, 115, 22, 0.3);
        }
        #extractLessonsBtn:hover {
            background-color: #ea580c;
        }

        #practicalApplicationsBtn {
            background-color: #14b8a6; /* فيروزي */
            color: white;
            box-shadow: 0 5px 15px rgba(20, 184, 166, 0.3);
        }
        #practicalApplicationsBtn:hover {
            background-color: #0d9488;
        }

        #askAIBtn {
            background-color: #6366f1; /* بنفسجي */
            color: white;
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }
        #askAIBtn:hover {
            background-color: #4f46e5;
        }

        /* تحسين حقول الإدخال */
        input[type="text"] {
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid #cbd5e1;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
        }
        input[type="text"]:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="card-container text-center">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8">حديث اليوم ✨</h1>

        <div class="mb-8">
            <button id="fetchNewHadithBtn" class="action-button">
                جلب حديث جديد
            </button>
        </div>

        <div id="hadithDisplay" class="content-display text-arabic">
            <p class="text-gray-800 text-lg leading-relaxed mb-4" id="hadithText">
                اضغط على الزر أعلاه لجلب حديث شريف جديد.
            </p>
            <p class="text-gray-600 text-sm font-medium" id="hadithSource">
                المصدر: -
            </p>
            <button id="copyHadithBtn" class="copy-button mt-4">
                نسخ الحديث
            </button>
            <span id="hadithCopyStatus" class="copy-status ml-2 hidden">تم النسخ!</span>
        </div>

        <div class="mt-8 flex flex-wrap justify-center gap-4">
            <button id="explainHadithBtn" class="action-button">
                ✨ اشرح الحديث
            </button>
            <button id="extractLessonsBtn" class="action-button">
                ✨ استخلص الدروس المستفادة
            </button>
            <button id="practicalApplicationsBtn" class="action-button">
                ✨ تطبيقات عملية
            </button>
        </div>

        <div class="mb-6 mt-8 p-6 border border-gray-200 rounded-xl bg-gray-50 shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">اسأل الذكاء الاصطناعي</h2>
            <div class="mb-4 flex items-center justify-center gap-2">
                <label for="searchInput" class="sr-only">اطرح سؤالك هنا:</label>
                <input type="text" id="searchInput" placeholder="اطرح سؤالك هنا"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2.5 px-4 text-gray-700 leading-tight
                              focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:shadow-md">
            </div>
            <button id="askAIBtn" class="action-button">
                💡 اسأل الذكاء الاصطناعي
            </button>
        </div>

        <div id="explanationDisplay" class="content-display bg-blue-50 border-blue-200">
            <h3 class="text-xl font-bold text-blue-800 mb-2">شرح الحديث:</h3>
            <p class="text-blue-800 text-lg leading-relaxed" id="explanationText">
                الشرح سيظهر هنا...
            </p>
            <button id="copyExplanationBtn" class="copy-button mt-4">
                نسخ الشرح
            </button>
            <span id="explanationCopyStatus" class="copy-status ml-2 hidden">تم النسخ!</span>
        </div>

        <div id="lessonsDisplay" class="content-display bg-orange-50 border-orange-200">
            <h3 class="text-xl font-bold text-orange-800 mb-2">الدروس المستفادة:</h3>
            <p class="text-orange-800 text-lg leading-relaxed" id="lessonsText">
                الدروس المستفادة ستظهر هنا...
            </p>
            <button id="copyLessonsBtn" class="copy-button mt-4">
                نسخ الدروس
            </button>
            <span id="lessonsCopyStatus" class="copy-status ml-2 hidden">تم النسخ!</span>
        </div>

        <div id="practicalApplicationsDisplay" class="content-display bg-teal-50 border-teal-200">
            <h3 class="text-xl font-bold text-teal-800 mb-2">تطبيقات عملية:</h3>
            <p class="text-teal-800 text-lg leading-relaxed" id="practicalApplicationsText">
                التطبيقات العملية ستظهر هنا...
            </p>
            <button id="copyPracticalApplicationsBtn" class="copy-button mt-4">
                نسخ التطبيقات
            </button>
            <span id="practicalApplicationsCopyStatus" class="copy-status ml-2 hidden">تم النسخ!</span>
        </div>

        <div id="aiAnswerDisplay" class="content-display bg-indigo-50 border-indigo-200">
            <h3 class="text-xl font-bold text-indigo-800 mb-2">إجابة الذكاء الاصطناعي:</h3>
            <p class="text-indigo-800 text-lg leading-relaxed" id="aiAnswerText">
                الإجابة ستظهر هنا...
            </p>
            <button id="copyAIAnswerBtn" class="copy-button mt-4">
                نسخ الإجابة
            </button>
            <span id="aiAnswerCopyStatus" class="copy-status ml-2 hidden">تم النسخ!</span>
        </div>

        <div id="loadingIndicator" class="hidden mt-4 text-gray-600 font-medium text-lg">
            جاري التحميل...
        </div>

        <div id="explanationLoadingIndicator" class="hidden mt-4 text-blue-600 font-medium text-lg">
            جاري شرح الحديث...
        </div>

        <div id="lessonsLoadingIndicator" class="hidden mt-4 text-orange-600 font-medium text-lg">
            جاري استخلاص الدروس...
        </div>

        <div id="practicalApplicationsLoadingIndicator" class="hidden mt-4 text-teal-600 font-medium text-lg">
            جاري اقتراح تطبيقات عملية...
        </div>

        <div id="aiAnswerLoadingIndicator" class="hidden mt-4 text-indigo-600 font-medium text-lg">
            جاري الإجابة...
        </div>

        <div id="errorDisplay" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-200 text-base">
            عذراً، حدث خطأ أثناء جلب الحديث. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.
        </div>

        <div id="explanationErrorDisplay" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-200 text-base">
            عذراً، حدث خطأ أثناء شرح الحديث. يرجى المحاولة مرة أخرى.
        </div>

        <div id="lessonsErrorDisplay" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-200 text-base">
            عذراً، حدث خطأ أثناء استخلاص الدروس. يرجى المحاولة مرة أخرى.
        </div>

        <div id="practicalApplicationsErrorDisplay" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-200 text-base">
            عذراً، حدث خطأ أثناء اقتراح تطبيقات عملية. يرجى المحاولة مرة أخرى.
        </div>

        <div id="aiAnswerErrorDisplay" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-200 text-base">
            عذراً، حدث خطأ أثناء معالجة سؤالك. يرجى المحاولة مرة أخرى.
        </div>
    </div>

    <script>
        // Getting references to DOM elements by their IDs
        const fetchNewHadithBtn = document.getElementById('fetchNewHadithBtn');
        const explainHadithBtn = document.getElementById('explainHadithBtn');
        const extractLessonsBtn = document.getElementById('extractLessonsBtn');
        const practicalApplicationsBtn = document.getElementById('practicalApplicationsBtn');
        const searchInput = document.getElementById('searchInput');
        const askAIBtn = document.getElementById('askAIBtn');

        const hadithText = document.getElementById('hadithText');
        const hadithSource = document.getElementById('hadithSource');
        const copyHadithBtn = document.getElementById('copyHadithBtn');
        const hadithCopyStatus = document.getElementById('hadithCopyStatus');

        const explanationDisplay = document.getElementById('explanationDisplay');
        const explanationText = document.getElementById('explanationText');
        const copyExplanationBtn = document.getElementById('copyExplanationBtn');
        const explanationCopyStatus = document.getElementById('explanationCopyStatus');

        const lessonsDisplay = document.getElementById('lessonsDisplay');
        const lessonsText = document.getElementById('lessonsText');
        const copyLessonsBtn = document.getElementById('copyLessonsBtn');
        const lessonsCopyStatus = document.getElementById('lessonsCopyStatus');

        const practicalApplicationsDisplay = document.getElementById('practicalApplicationsDisplay');
        const practicalApplicationsText = document.getElementById('practicalApplicationsText');
        const copyPracticalApplicationsBtn = document.getElementById('copyPracticalApplicationsBtn');
        const practicalApplicationsCopyStatus = document.getElementById('practicalApplicationsCopyStatus');

        const aiAnswerDisplay = document.getElementById('aiAnswerDisplay');
        const aiAnswerText = document.getElementById('aiAnswerText');
        const copyAIAnswerBtn = document.getElementById('copyAIAnswerBtn');
        const aiAnswerCopyStatus = document.getElementById('aiAnswerCopyStatus');

        const loadingIndicator = document.getElementById('loadingIndicator');
        const explanationLoadingIndicator = document.getElementById('explanationLoadingIndicator');
        const lessonsLoadingIndicator = document.getElementById('lessonsLoadingIndicator');
        const practicalApplicationsLoadingIndicator = document.getElementById('practicalApplicationsLoadingIndicator');
        const aiAnswerLoadingIndicator = document.getElementById('aiAnswerLoadingIndicator');
        const errorDisplay = document.getElementById('errorDisplay');
        const explanationErrorDisplay = document.getElementById('explanationErrorDisplay');
        const lessonsErrorDisplay = document.getElementById('lessonsErrorDisplay');
        const practicalApplicationsErrorDisplay = document.getElementById('practicalApplicationsErrorDisplay');
        const aiAnswerErrorDisplay = document.getElementById('aiAnswerErrorDisplay');

        // List of available Hadith books and their available count
        const hadithBooksData = [
            { name: "HR. Abu Daud", id: "abu-daud", available: 4419 },
            { name: "HR. Ahmad", id: "ahmad", available: 4305 },
            { name: "HR. Bukhari", id: "bukhari", available: 6638 },
            { name: "HR. Darimi", id: "darimi", available: 2949 },
            { name: "HR. Ibnu Majah", id: "ibnu-majah", available: 4285 },
            { name: "HR. Malik", id: "malik", available: 1587 },
            { name: "HR. Muslim", id: "muslim", available: 4930 },
            { name: "HR. Nasai", id: "nasai", available: 5364 },
            { name: "HR. Tirmidzi", id: "tirmidzi", available: 3625 }
        ];

        // Speech Synthesis variables (kept for reading out AI answers)
        let synth;
        let arabicVoice;

        // Initialize SpeechSynthesis
        if ('speechSynthesis' in window) {
            synth = window.speechSynthesis;
            synth.onvoiceschanged = () => {
                const voices = synth.getVoices();
                arabicVoice = voices.find(voice => voice.lang.startsWith('ar')) || voices.find(voice => voice.lang.includes('ar'));
                if (!arabicVoice) {
                    console.warn('No Arabic voice found. Default voice will be used.');
                }
            };
        } else {
            console.warn('Your browser does not support speech output.');
        }

        /**
         * Helper function to disable or enable all buttons.
         * @param {boolean} disable - true to disable buttons, false to enable them.
         */
        function disableAllButtons(disable) {
            fetchNewHadithBtn.disabled = disable;
            explainHadithBtn.disabled = disable;
            extractLessonsBtn.disabled = disable;
            practicalApplicationsBtn.disabled = disable;
            askAIBtn.disabled = disable;
            copyHadithBtn.disabled = disable;
            copyExplanationBtn.disabled = disable;
            copyLessonsBtn.disabled = disable;
            copyPracticalApplicationsBtn.disabled = disable;
            copyAIAnswerBtn.disabled = disable;
        }

        // Helper function to hide all status messages, extra display areas, and copy statuses
        function hideAllStatusMessages() {
            loadingIndicator.classList.add('hidden');
            explanationLoadingIndicator.classList.add('hidden');
            lessonsLoadingIndicator.classList.add('hidden');
            practicalApplicationsLoadingIndicator.classList.add('hidden');
            aiAnswerLoadingIndicator.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            explanationErrorDisplay.classList.add('hidden');
            lessonsErrorDisplay.classList.add('hidden');
            practicalApplicationsErrorDisplay.classList.add('hidden');
            aiAnswerErrorDisplay.classList.add('hidden');
            explanationDisplay.classList.add('hidden');
            lessonsDisplay.classList.add('hidden');
            practicalApplicationsDisplay.classList.add('hidden');
            aiAnswerDisplay.classList.add('hidden');

            // Hide copy status messages
            hadithCopyStatus.classList.add('hidden');
            explanationCopyStatus.classList.add('hidden');
            lessonsCopyStatus.classList.add('hidden');
            practicalApplicationsCopyStatus.classList.add('hidden');
            aiAnswerCopyStatus.classList.add('hidden');
        }

        /**
         * Helper function to copy text to clipboard.
         * Uses document.execCommand('copy') as navigator.clipboard.writeText() might not work in iframe environments.
         * @param {string} textToCopy - The text to be copied.
         * @param {HTMLElement} statusElement - The element that will display the status message (e.g., "Copied!").
         */
        function copyTextToClipboard(textToCopy, statusElement) {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                if (statusElement) {
                    statusElement.classList.remove('hidden');
                    setTimeout(() => {
                        statusElement.classList.add('hidden');
                    }, 2000); // Hide message after 2 seconds
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
                // Optionally, add a visible error message to the user here
            } finally {
                document.body.removeChild(tempTextArea);
            }
        }

        /**
         * Asynchronous function to fetch a random hadith from a selected book.
         * A random number is chosen within the available range of hadiths for the book.
         */
        async function fetchHadithOfTheDay() {
            hideAllStatusMessages(); // Hide all messages before starting
            loadingIndicator.classList.remove('hidden');
            disableAllButtons(true); // Disable all buttons

            try {
                // Choose a random book from the list of available books
                const randomBookData = hadithBooksData[Math.floor(Math.random() * hadithBooksData.length)];
                const randomBookId = randomBookData.id;
                const maxHadithNumber = randomBookData.available;

                // Choose a random hadith number within the available range for this book
                const randomHadithNumber = Math.floor(Math.random() * maxHadithNumber) + 1;

                const apiUrl = `https://api.hadith.gading.dev/books/${randomBookId}/${randomHadithNumber}`;
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data && data.data && data.data.contents && data.data.contents.arab) {
                    hadithText.textContent = data.data.contents.arab;
                    hadithSource.textContent = `المصدر: ${data.data.name} - حديث رقم ${data.data.contents.number}`;
                } else {
                    console.warn(`Hadith not found for ${randomBookId} at number ${randomHadithNumber}. Trying again.`);
                    await fetchHadithOfTheDay(); // Try fetching another hadith
                    return; // End current execution to avoid updating the UI twice
                }

            } catch (error) {
                console.error('Error fetching hadith:', error);
                errorDisplay.classList.remove('hidden');
                hadithText.textContent = 'تعذر جلب الحديث. يرجى المحاولة لاحقاً.';
                hadithSource.textContent = 'المصدر: -';
            } finally {
                loadingIndicator.classList.add('hidden');
                disableAllButtons(false); // Re-enable all buttons
            }
        }

        /**
         * Asynchronous function to explain the hadith using Gemini API.
         */
        async function explainHadith() {
            const currentHadith = hadithText.textContent;

            if (!currentHadith || currentHadith.includes('اضغط على الزر') || currentHadith.includes('تعذر جلب الحديث') || currentHadith.includes('لم يتم العثور على حديث')) {
                explanationText.textContent = 'يرجى جلب حديث أولاً قبل طلب الشرح.';
                explanationDisplay.classList.remove('hidden');
                return;
            }

            hideAllStatusMessages(); // Hide all other messages and areas
            explanationLoadingIndicator.classList.remove('hidden');
            disableAllButtons(true); // Disable all buttons

            try {
                const prompt = `اشرح الحديث التالي بأسلوب مبسط ومختصر، مع التركيز على المعنى العام والفائدة المستفادة منه، وبما لا يتجاوز 150 كلمة، مع ذكر المصدر إن أمكن: "${currentHadith}"`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // IMPORTANT: When deploying this application outside of the Google Canvas environment,
                // you need to provide your own Gemini API Key.
                // You can get one from Google AI Studio: https://aistudio.google.com/app/apikey
                //
                // WARNING: Directly embedding API keys in client-side code is NOT secure for production applications.
                // For production, it is highly recommended to use a backend proxy server to keep your API key secure.
                const apiKey = "AIzaSyDbeleLFWRXBWVMS7eyzRvoR6Sj-wsIjwY"; // <-- مفتاح الـ API الخاص بك هنا
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('Explain Hadith API Response:', result); // Log the full response

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const explanation = result.candidates[0].content.parts[0].text;
                    explanationText.textContent = explanation;
                    explanationDisplay.classList.remove('hidden');
                } else {
                    // Check if there's a 'promptFeedback' with 'blockReason'
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        console.error('API blocked due to:', result.promptFeedback.blockReason);
                        throw new Error(`تم حظر الشرح بواسطة الذكاء الاصطناعي بسبب: ${result.promptFeedback.blockReason}`);
                    } else {
                        console.error('Unexpected API response structure for Explain Hadith:', result);
                        throw new Error('لم يتم الحصول على شرح من الذكاء الاصطناعي. بنية استجابة غير متوقعة.');
                    }
                }

            } catch (error) {
                console.error('Error explaining hadith:', error);
                explanationErrorDisplay.textContent = `عذراً، حدث خطأ أثناء شرح الحديث: ${error.message}. يرجى المحاولة مرة أخرى.`;
                explanationErrorDisplay.classList.remove('hidden');
                explanationText.textContent = 'تعذر شرح الحديث. يرجى المحاولة لاحقاً.';
                explanationDisplay.classList.remove('hidden');
            } finally {
                explanationLoadingIndicator.classList.add('hidden');
                disableAllButtons(false); // Re-enable all buttons
            }
        }

        /**
         * Asynchronous function to extract lessons learned from the hadith using Gemini API.
         */
        async function extractLessons() {
            const currentHadith = hadithText.textContent;

            if (!currentHadith || currentHadith.includes('اضغط على الزر') || currentHadith.includes('تعذر جلب الحديث') || currentHadith.includes('لم يتم العثور على حديث')) {
                lessonsText.textContent = 'يرجى جلب حديث أولاً قبل طلب استخلاص الدروس.';
                lessonsDisplay.classList.remove('hidden');
                return;
            }

            hideAllStatusMessages(); // Hide all other messages and areas
            lessonsLoadingIndicator.classList.remove('hidden');
            disableAllButtons(true); // Disable all buttons

            try {
                const prompt = `استخلص أهم 3-5 دروس أو فوائد مستفادة من الحديث التالي بأسلوب نقطي ومختصر: "${currentHadith}"`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // IMPORTANT: When deploying this application outside of the Google Canvas environment,
                // you need to provide your own Gemini API Key.
                // You can get one from Google AI Studio: https://aistudio.google.com/app/apikey
                //
                // WARNING: Directly embedding API keys in client-side code is NOT secure for production applications.
                // For production, it is highly recommended to use a backend proxy server to keep your API key secure.
                const apiKey = "AIzaSyDbeleLFWRXBWVMS7eyzRvoR6Sj-wsIjwY"; // <-- مفتاح الـ API الخاص بك هنا
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('Extract Lessons API Response:', result); // Log the full response

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const lessons = result.candidates[0].content.parts[0].text;
                    lessonsText.textContent = lessons;
                    lessonsDisplay.classList.remove('hidden');
                } else {
                    // Check if there's a 'promptFeedback' with 'blockReason'
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        console.error('API blocked due to:', result.promptFeedback.blockReason);
                        throw new Error(`تم حظر استخلاص الدروس بواسطة الذكاء الاصطناعي بسبب: ${result.promptFeedback.blockReason}`);
                    } else {
                        console.error('Unexpected API response structure for Extract Lessons:', result);
                        throw new Error('لم يتم الحصول على دروس من الذكاء الاصطناعي. بنية استجابة غير متوقعة.');
                    }
                }

            } catch (error) {
                console.error('Error extracting lessons:', error);
                lessonsErrorDisplay.textContent = `عذراً، حدث خطأ أثناء استخلاص الدروس: ${error.message}. يرجى المحاولة مرة أخرى.`;
                lessonsErrorDisplay.classList.remove('hidden');
                lessonsText.textContent = 'تعذر استخلاص الدروس. يرجى المحاولة لاحقاً.';
                lessonsDisplay.classList.remove('hidden');
            } finally {
                lessonsLoadingIndicator.classList.add('hidden');
                disableAllButtons(false); // Re-enable all buttons
            }
        }

        /**
         * Asynchronous function to generate practical applications for the hadith using Gemini API.
         */
        async function generatePracticalApplications() {
            const currentHadith = hadithText.textContent;

            if (!currentHadith || currentHadith.includes('اضغط على الزر') || currentHadith.includes('تعذر جلب الحديث') || currentHadith.includes('لم يتم العثور على حديث')) {
                practicalApplicationsText.textContent = 'يرجى جلب حديث أولاً قبل طلب تطبيقات عملية.';
                practicalApplicationsDisplay.classList.add('hidden');
                return;
            }

            hideAllStatusMessages(); // Hide all other messages and areas
            practicalApplicationsLoadingIndicator.classList.remove('hidden');
            disableAllButtons(true); // Disable all buttons

            try {
                const prompt = `بناءً على الحديث التالي، اقترح 3-5 تطبيقات عملية أو خطوات يمكن للمسلم اتخاذها في حياته اليومية لتطبيق هذا الحديث، بأسلوب نقطي ومختصر: "${currentHadith}"`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // IMPORTANT: When deploying this application outside of the Google Canvas environment,
                // you need to provide your own Gemini API Key.
                // You can get one from Google AI Studio: https://aistudio.google.com/app/apikey
                //
                // WARNING: Directly embedding API keys in client-side code is NOT secure for production applications.
                // For production, it is highly recommended to use a backend proxy server to keep your API key secure.
                const apiKey = "AIzaSyDbeleLFWRXBWVMS7eyzRvoR6Sj-wsIjwY"; // <-- مفتاح الـ API الخاص بك هنا
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('Practical Applications API Response:', result); // Log the full response

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const applications = result.candidates[0].content.parts[0].text;
                    practicalApplicationsText.textContent = applications;
                    practicalApplicationsDisplay.classList.remove('hidden');
                } else {
                    // Check if there's a 'promptFeedback' with 'blockReason'
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        console.error('API blocked due to:', result.promptFeedback.blockReason);
                        throw new Error(`تم حظر اقتراح التطبيقات بواسطة الذكاء الاصطناعي بسبب: ${result.promptFeedback.blockReason}`);
                    } else {
                        console.error('Unexpected API response structure for Practical Applications:', result);
                        throw new Error('لم يتم الحصول على تطبيقات عملية من الذكاء الاصطناعي. بنية استجابة غير متوقعة.');
                    }
                }

            } catch (error) {
                console.error('Error generating practical applications:', error);
                practicalApplicationsErrorDisplay.textContent = `عذراً، حدث خطأ أثناء اقتراح تطبيقات عملية: ${error.message}. يرجى المحاولة مرة أخرى.`;
                practicalApplicationsErrorDisplay.classList.remove('hidden');
                practicalApplicationsText.textContent = 'تعذر اقتراح تطبيقات عملية. يرجى المحاولة لاحقاً.';
                practicalApplicationsDisplay.classList.remove('hidden');
            } finally {
                practicalApplicationsLoadingIndicator.classList.add('hidden');
                disableAllButtons(false); // Re-enable all buttons
            }
        }

        /**
         * Asynchronous function to answer user questions using Gemini API.
         */
        async function askAI() {
            const query = searchInput.value.trim();

            if (!query) {
                aiAnswerText.textContent = 'الرجاء إدخال سؤالك.';
                aiAnswerDisplay.classList.remove('hidden');
                return;
            }

            hideAllStatusMessages(); // Hide all other messages and areas
            aiAnswerLoadingIndicator.classList.remove('hidden');
            disableAllButtons(true); // Disable all buttons

            try {
                const prompt = `أجب على السؤال التالي بناءً على معرفتك بالأحاديث والمفاهيم الإسلامية: "${query}". قدم إجابة شاملة ومختصرة.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // IMPORTANT: When deploying this application outside of the Google Canvas environment,
                // you need to provide your own Gemini API Key.
                // You can get one from Google AI Studio: https://aistudio.google.com/app/apikey
                //
                // WARNING: Directly embedding API keys in client-side code is NOT secure for production applications.
                // For production, it is highly recommended to use a backend proxy server to keep your API key secure.
                const apiKey = "AIzaSyDbeleLFWRXBWVMS7eyzRvoR6Sj-wsIjwY"; // <-- مفتاح الـ API الخاص بك هنا
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('Ask AI API Response:', result); // Log the full response

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const answer = result.candidates[0].content.parts[0].text;
                    aiAnswerText.textContent = answer;
                    aiAnswerDisplay.classList.remove('hidden');

                    // Read the answer aloud
                    if (synth && arabicVoice) {
                        const utterance = new SpeechSynthesisUtterance(answer);
                        utterance.voice = arabicVoice;
                        utterance.lang = 'ar-SA';
                        synth.speak(utterance);
                    } else if (synth) {
                        const utterance = new SpeechSynthesisUtterance(answer);
                        synth.speak(utterance);
                    }

                } else {
                    // Check if there's a 'promptFeedback' with 'blockReason'
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        console.error('API blocked due to:', result.promptFeedback.blockReason);
                        throw new Error(`تم حظر الإجابة بواسطة الذكاء الاصطناعي بسبب: ${result.promptFeedback.blockReason}`);
                    } else {
                        console.error('Unexpected API response structure for Ask AI:', result);
                        throw new Error('لم يتم الحصول على إجابة من الذكاء الاصطناعي. بنية استجابة غير متوقعة.');
                    }
                }

            } catch (error) {
                console.error('Error answering question:', error);
                aiAnswerErrorDisplay.textContent = `عذراً، حدث خطأ أثناء معالجة سؤالك: ${error.message}. يرجى المحاولة مرة أخرى.`;
                aiAnswerErrorDisplay.classList.remove('hidden');
                aiAnswerText.textContent = 'تعذر الإجابة على سؤالك. يرجى المحاولة لاحقاً.';
                aiAnswerDisplay.classList.remove('hidden');
            } finally {
                aiAnswerLoadingIndicator.classList.add('hidden');
                disableAllButtons(false); // Re-enable all buttons
            }
        }

        // Add click listener for "Fetch New Hadith" button
        fetchNewHadithBtn.addEventListener('click', fetchHadithOfTheDay);

        // Add click listener for "Explain Hadith" button
        explainHadithBtn.addEventListener('click', explainHadith);

        // Add click listener for "Extract Lessons" button
        extractLessonsBtn.addEventListener('click', extractLessons);

        // Add click listener for "Practical Applications" button
        practicalApplicationsBtn.addEventListener('click', generatePracticalApplications);

        // Add click listener for "Ask AI" button
        askAIBtn.addEventListener('click', askAI);

        // Add click listeners for copy buttons
        copyHadithBtn.addEventListener('click', () => copyTextToClipboard(hadithText.textContent, hadithCopyStatus));
        copyExplanationBtn.addEventListener('click', () => copyTextToClipboard(explanationText.textContent, explanationCopyStatus));
        copyLessonsBtn.addEventListener('click', () => copyTextToClipboard(lessonsText.textContent, lessonsCopyStatus));
        copyPracticalApplicationsBtn.addEventListener('click', () => copyTextToClipboard(practicalApplicationsText.textContent, practicalApplicationsCopyStatus));
        copyAIAnswerBtn.addEventListener('click', () => copyTextToClipboard(aiAnswerText.textContent, aiAnswerCopyStatus));


        // Fetch a hadith automatically on page load
        document.addEventListener('DOMContentLoaded', fetchHadithOfTheDay);
    </script>
</body>
</html>
